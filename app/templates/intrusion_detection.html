<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络入侵检测与防御系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fa fa-shield"></i> 网络入侵检测系统
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="切换导航">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">主页</a>
                    </li>
                    <!-- <li class="nav-item">
                        <a class="nav-link" href="/dashboard">仪表盘</a>
                    </li> -->
                    <li class="nav-item">
                        <a class="nav-link" href="/logs">日志</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/settings">设置</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="alert alert-info" role="alert">
                    <i class="fa fa-info-circle"></i> 仪表盘数据每秒自动更新。系统状态：<span id="systemStatusBadge" class="badge bg-danger">未运行</span>
                </div>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card dashboard-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="icon-box bg-primary">
                                <i class="fa fa-exchange"></i>
                            </div>
                            <div class="ms-3">
                                <h6 class="text-muted">网络流量</h6>
                                <h4 id="trafficStat">0 KB/s</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card dashboard-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="icon-box bg-success">
                                <i class="fa fa-server"></i>
                            </div>
                            <div class="ms-3">
                                <h6 class="text-muted">活跃连接</h6>
                                <h4 id="connectionsStat">0</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card dashboard-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="icon-box bg-warning">
                                <i class="fa fa-exclamation-triangle"></i>
                            </div>
                            <div class="ms-3">
                                <h6 class="text-muted">检测到的威胁</h6>
                                <h4 id="threatsStat">0</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">最近检测到的威胁</h5>
                    </div>
                    <div class="card-body threat-list-container">
                        <div id="threatList" class="threat-list">
                            <div class="text-center text-muted">
                                <i class="fa fa-spin fa-spinner"></i> 加载威胁数据...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">攻击类型统计</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="attackTypeChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>         

    <footer class="footer mt-5 py-3 bg-dark text-white">
        <div class="container text-center">
            <p>&copy; 2025 网络入侵检测系统 | by kja</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.4.0/dist/socket.io.min.js"></script>
    <script>
        // 仪表盘JavaScript文件

        $(document).ready(function() {
            // 连接WebSocket
            const socket = io();
            
            // 图表对象
            let attackTypeChart = null;
                       
            // 攻击类型数据
            const attackData = {
                labels: [],
                counts: []
            };
            
            
            // 威胁数据
            let threatList = [];
            
            // 时间范围（默认10分钟）
            let timeRange = 10;
            // 获取初始数据
            fetchInitialData();
            // 初始化图表
            initCharts();
            
            // SocketIO事件处理
            setupSocketEvents();
            
            
            
            // 设置按钮事件
            setupButtonEvents();
            
            // 初始化图表
            function initCharts() {
                
                // 攻击类型图表
                const attackCtx = document.getElementById('attackTypeChart').getContext('2d');
                attackTypeChart = new Chart(attackCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '攻击次数',
                            data: [],
                            backgroundColor: 'rgba(217, 4, 41, 0.7)',
                            borderColor: 'rgba(217, 4, 41, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // 设置Socket事件
            function setupSocketEvents() {
                socket.on('connect', function() {
                    console.log('Socket.IO connected');
                    updateSystemStatus(true);
                });
                
                socket.on('disconnect', function() {
                    console.log('Socket.IO disconnected');
                    updateSystemStatus(false);
                });
                
                socket.on('network_stats', function(data) {
                    updateDashboardStats(data);                    
                });               
                // 处理威胁数据更新
                socket.on('threat_update', function(data) {
                    updateThreatList(data);
                    updateAttackChart(data);
                });
                
                // 处理状态更新
                socket.on('status_update', function(data) {
                    updateSystemStatus(true, data.is_running);
                });
            }
            
            // 获取最新数据
            function fetchData() {
                // 获取系统状态
                $.get('/api/status', function(data) {
                    console.log("获取系统状态");
                    updateSystemStatus(true, data.is_running);
                });
                
                // 获取网络统计数据
                $.get('/api/network_stats', function(data) {
                    updateDashboardStats(data);                    
                });
                
                // 获取威胁数据
                $.get('/api/threats', function(data) {
                    if (data.threats) {
                        updateThreatList(data.threats);
                        updateAttackChart({ attack_stats: countAttackTypes(data.threats) });
                    }
                });
            }
            
            // 获取初始数据
            function fetchInitialData() {
                fetchData();
                
                // 设置定时刷新 (每10秒刷新一次)
                setInterval(fetchData, 10000);
            }
            
            // 设置按钮事件
            function setupButtonEvents() {
                
            }
            
            // 更新系统状态
            function updateSystemStatus(connected, isRunning) {
                if (!connected) {
                    $('#systemStatusBadge').removeClass('bg-success bg-warning').addClass('bg-danger').text('已断开');
                    return;
                }
                
                if (isRunning !== undefined) {
                    if (isRunning) {
                        $('#systemStatusBadge').removeClass('bg-danger bg-warning').addClass('bg-success').text('运行中');
                    } else {
                        $('#systemStatusBadge').removeClass('bg-danger bg-success').addClass('bg-warning').text('已停止');
                    }
                } else {
                    // 如果没有提供isRunning，则直接发送请求获取状态
                    $.get('/api/status', function(data) {
                        if (data.is_running) {
                            $('#systemStatusBadge').removeClass('bg-danger bg-warning').addClass('bg-success').text('运行中');
                        } else {
                            $('#systemStatusBadge').removeClass('bg-danger bg-success').addClass('bg-warning').text('已停止');
                        }
                    });
                }
            }
            
            // 更新仪表盘统计数据
            function updateDashboardStats(data) {
                if (!data) return;

                // 流量统计
                if (data.traffic_in !== undefined && data.traffic_out !== undefined) {
                    const inTraffic = formatBytes(data.traffic_in) + '/s';
                    const outTraffic = formatBytes(data.traffic_out) + '/s';
                    $('#trafficStat').text(inTraffic + ' / ' + outTraffic);
                }
                
                // 活跃连接数
                if (data.connections !== undefined) {
                    $('#connectionsStat').text(data.connections);
                }
                
                // 检测到的威胁数
                if (data.threats_detected !== undefined) {
                    $('#threatsStat').text(data.threats_detected);
                }
                
                
                // 处理的数据包数
                if (data.packets_processed !== undefined) {
                    $('#processedPackets').text(data.packets_processed);
                }
                
                // 如果没有提供这些数据，则模拟一些数据
                // if (data.connections === undefined) {
                //     $('#connectionsStat').text(Math.floor(Math.random() * 50) + 10);
                // }
                // if (data.threats_detected === undefined) {
                //     $('#threatsStat').text(Math.floor(Math.random() * 20));
                // }
                // if (data.ips_blocked === undefined) {
                //     $('#blockedIpsStat').text(Math.floor(Math.random() * 10));
                // }
                // if (data.packets_processed === undefined) {
                //     $('#processedPackets').text(Math.floor(Math.random() * 5000) + 1000);
                // }
            }
            
           
            // 更新攻击类型图表
            function updateAttackChart(data) {
                if (!data.attack_stats) return;
                
                const attackTypes = Object.keys(data.attack_stats);
                const counts = attackTypes.map(t => data.attack_stats[t]);
                
                // 排序
                const combined = attackTypes.map((type, i) => ({ type, count: counts[i] }));
                combined.sort((a, b) => b.count - a.count);
                
                // 取前8种攻击类型
                const topAttacks = combined.slice(0, 8);
                
                // 更新图表数据
                attackTypeChart.data.labels = topAttacks.map(a => a.type);
                attackTypeChart.data.datasets[0].data = topAttacks.map(a => a.count);
                attackTypeChart.update();
            }
            
            
            
            // 更新威胁列表
            function updateThreatList(threats) {
                if (!Array.isArray(threats)) return;
                
                // 保存威胁数据
                threatList = threats;
                
                // 生成HTML
                let threatHtml = '';
                
                // 最多显示5条最新的威胁
                const latestThreats = threats.slice(0, 5);
                
                latestThreats.forEach(threat => {
                    const time = new Date(threat.timestamp).toLocaleString();
                    const severity = threat.severity || '未知';
                    const severityClass = severity === '高' ? 'high' : (severity === '中' ? 'medium' : 'low');
                    
                    threatHtml += `<div class="threat-item">
                        <div class="d-flex justify-content-between">
                            <span>
                                <span class="threat-severity severity-${severityClass}"></span>
                                ${threat.threat_type || threat.alert_type || '未知威胁'}
                            </span>
                            <small class="text-muted">${time}</small>
                        </div>
                        <div class="mt-1">
                            <small>来源: ${threat.src_ip || '未知'} → ${threat.dst_ip || '未知'}</small>
                        </div>
                    </div>`;
                });
                
                if (threatHtml === '') {
                    threatHtml = '<div class="text-center text-muted p-3">无威胁记录</div>';
                }
                
                // 更新DOM
                $('#threatList').html(threatHtml);
            }
            
            
            
            
            
            // 计算攻击类型统计
            function countAttackTypes(threats) {
                const counts = {};
                
                threats.forEach(threat => {
                    const type = threat.threat_type || threat.alert_type || '未知';
                    if (!counts[type]) {
                        counts[type] = 0;
                    }
                    counts[type]++;
                });
                
                return counts;
            }
            
            // 格式化字节数
            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 B';
                
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
                
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }
        });

    </script>
</body>
</html>
